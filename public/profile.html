<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <title>用戶中心</title>
    <link rel="stylesheet" href="/ui.css">
</head>

<body>
    <header>
        <img src="https://www.allrecipes.com/thmb/WyCC-RL8cuAEKfYHsdnzqi64iTc=/1500x0/filters:no_upscale():max_bytes(150000):strip_icc()/73135-homestyle-potato-chips-ddmfs-0348-3x4-hero-c21021303c8849bbb40c1007bfa9af6e.jpg" alt="首頁" id="homeLogo" onclick="window.location.href='/'">
        <h1>用戶中心</h1>
    </header>
    <div id="profile">
        <img id="avatar" class="avatar" alt="用戶頭像">
        <h2 id="username"></h2>
        <button onclick="logout()">登出</button>
        <h3>修改頭像</h3>
        <input type="file" id="avatarInput" accept="image/*">
        <button onclick="uploadAvatar()">上傳頭像</button>
        <h3>修改密碼</h3>
        <input id="newPassword" type="password" placeholder="新密碼">
        <button onclick="updatePassword()">更新密碼</button>
        <p id="status"></p>
    </div>
    <h3>我的貼文</h3>
    <div id="userPosts"></div>

    <script>
        async function loadProfile() {
            const response = await fetch('/user');
            if (!response.ok) {
                window.location.href = '/';
                return;
            }
            const user = await response.json();
            document.getElementById('username').textContent = `用戶名稱: ${user.username}`;
            const avatarImg = document.getElementById('avatar');
            avatarImg.src = user.avatar_url || '/pt.jpg'; // 預設頭像
            loadUserPosts();
        }
        async function uploadAvatar() {
            const avatarFile = document.getElementById('avatarInput').files[0];
            if (!avatarFile) {
                alert('請選擇頭像圖片');
                return;
            }
            const reader = new FileReader();
            reader.onload = async function (e) {
                const avatarData = e.target.result.split(',')[1];
                const response = await fetch('/user/avatar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ avatar: avatarData })
                });
                const result = await response.json();
                alert(response.ok ? result.message : result.error);
                if (response.ok) {
                    document.getElementById('avatar').src = result.avatarUrl;
                    document.getElementById('avatarInput').value = '';
                }
            };
            reader.readAsDataURL(avatarFile);
        }
        async function loadUserPosts() {
            const response = await fetch('/user/posts');
            const posts = await response.json();
            const postsDiv = document.getElementById('userPosts');
            postsDiv.innerHTML = posts.map(post => `
                <div class="post">
                    <p>${post.content}</p>
                    ${post.image_url ? `<img src="${post.image_url}" alt="貼文圖片" class="post-image">` : ''}
                    <small>發布時間: ${new Date(post.created_at).toLocaleString()}</small>
                    <div class="interactions">
                        <button onclick="deletePost(${post.id})" class="delete-btn">刪除</button>
                    </div>
                </div>
            `).join('');
        }

        async function updatePassword() {
            const newPassword = document.getElementById('newPassword').value;
            if (!newPassword) {
                alert('請輸入新密碼');
                return;
            }
            const response = await fetch('/user/password', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: newPassword })
            });
            const result = await response.json();
            alert(response.ok ? result.message : result.error);
            if (response.ok) document.getElementById('newPassword').value = '';
        }

        async function deletePost(postId) {
            if (confirm('確定要刪除這篇貼文嗎？')) {
                const response = await fetch(`/posts/${postId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                alert(response.ok ? result.message : result.error);
                if (response.ok) loadUserPosts();
            }
        }

        async function logout() {
            await fetch('/logout', { method: 'POST' });
            window.location.href = '/';
        }

        loadProfile();
    </script>
</body>

</html>